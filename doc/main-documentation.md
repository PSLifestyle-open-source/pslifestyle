# PS Lifestyle

Documentation of solution

## Detailed documentations:

- [App data initiation](./detailed_feature_doc/app-data-initiation.md)
- [Users and Sessions](./detailed_feature_doc/users-and-sessions.md)
- [Questionnaire](./detailed_feature_doc/questionnaire.md)
- [Actions and plan](./detailed_feature_doc/actions-and-plan.md)
- [Campaign](./detailed_feature_doc/campaign.md)
- [Feedback](./detailed_feature_doc/feedback.md)
- [API Schema](./api-schema.json)
- [API detailed description](./detailed_feature_doc/api-detailed-description.md)
- [Google Sheets description](./detailed_feature_doc/google-sheets.md)

## Introduction to project

PSLifestyle test is an application, where users can fill a questionnaire about their life routines and to get to know their
carbon footprint. Based on this information, the app presents list of recommendations, which can be added to user's
carbon footprint reduction plan, where they can track the progress of selected actions.

## Functionality overview

This section describes main functionalities provided by PS Lifestyle app.

### Users

The application can be used by both logged in and anonymous users, allowing them to fill a questionnaire
and create the plan, as well as to give feedback.

The benefit of logging in is, the actions included to user's plan gets assigned to the user's account,
and it can be accessed later.
Data of anonymous users are stored until the user closes their browser/browser tab with the app.

Logged-in users can delete their account, what will result also in their other data being deleted
(unless it was already pseudo-anonymized for the analytics purpose).

Login happens using magic link (link sent via email to the user, which makes user logged in after opening the link).

No PII are stored within the application. The only information about user (email address) is only used to send magic
link email, and then gets stored in a database in a **hashed form** (to not allow to obtain original value, unless we
know it already).

#### Roles

Roles are special tags assigned to users, enabling them different extra capabilities within the system.

Existing roles:

| Role name        | description                                                   |
|------------------|---------------------------------------------------------------|
| CAMPAIGN_MANAGER | Can manage campaign(s) for countries the user was assigned to |
| USER_MANAGER     | Can manage roles for other users                              |

### Questionnaire

The questionnaire is one of main functionalities, where users can answer questions about their lifestyle,
and get to know how their decisions affect amount of CO2 emissions they produce.

Questions are country-specific.

Some questions only appear if specific answer was selected during previous question.

Questionnaire is split into 4 main categories: "house", "transport", "food" and "purchases", each of them having several
of single answer questions.

After the main part of questionnaire (answering to questions from mentioned 4 categories), users get a possibility to
answer several demographic-related questions (like age, size of city they live in, etc), which can be later used for
analytics purpose. This is optional for users, and they can skip demographic questions.

After the questionnaire is finished, users are presented with result page, where they can see both summarized and
detailed information about the emission they produce and how their emission is in comparison to their and other
countries. Users can also share their result with their friends using email or other options.

### Plan

After users finish the questionnaire, they can continue to create a plan, which should help them find ways to reduce
their carbon footprint production.

Actions which are presented to the user are country-dependent, but also depends on selected answers given in the
questionnaire. For example, if user already has an electric car, the action to switch to the electric car will
not be presented.

Each action has also an "impact", which determines how much the user will reduce the emission production if the action
will be achieved. Formulas for impact are either static values, or they depend on the answers selected by the user.

User can interact with actions by clicking one of three buttons:

- "I can't do this" - User can click it, when it's not applicable to user. In such case, reason(s) will be asked, and
  then action removed from user's list afterwards
- "I already do this" - In this case, the footprint generated by user gets reduced, but action will not be included to
  user's plan
- "Choose action" - Adds actions to the plan

After user added the action to the plan, the action can be completed, whenever user feels the action is done, resulting
in all related visuals to show how much this reduction affected the overall user's footprint.

### Campaign ID / Custom link

Campaign ID is a token, which can be added to the URL when sharing the link to the application.

The purpose of the campaign ID is to narrow down users to specific campaigns, for example for specific cities or events.

The campaign ID is assigned to the user (either anonymous or logged in), resulting in all actions done by the user
being connected to that campaign. In case of anonymous users, that campaign ID will be valid only until session expires
(user closes the browser/tab with the application).

Campaign ID can also limit which countries are allowed to be used by the user (for example, by opening link with
specific campaign ID, user might be limited to use only the Italian questionnaire), as well as it will enforce the place
where user will be redirected on opening the link (either homepage, or directly to the test/questionnaire).

## Application architecture and design

Application was created with usage of Google Firebase and Firestore in mind, that's why some part of it might be
strongly impacted by

The application consists of following packages:

- frontend (`./packages/enduser-ui`)
- backend (`./packages/functions`)
- common (`./packages/common`)

### Frontend

ReactJS-based frontend SPA, with Redux for state management and Tailwind and Radix UI for styling/re-usable components.

The directory structure is arranged in following way:

- ./cypress - UI tests for the application.
- ./public - Assets which needs to be accessible by users
- ./src - Entire codebase
    - ./app - main App.tsx and all other core components needed by the application to ensure correct behavior (routing,
      authentication, etc).
    - ./assets - Assets which are used as React components
    - ./common - Common elements which can be used by any feature of the application.
        - ./components - UI components (Buttons, Cards, Banners, etc)
        - ./hooks - React Hooks
        - ./pages - Generic Pages (eg. error page)
        - ./store - Redux state management store
        - ./utils - Helper functions
    - ./features - Non-shareable components, which were created for specific feature
    - ./firebase - API layer for the application, with all files/functions required to fulfill the need of the app.
      Endpoints are documented inside [API Schema](./api-schema.json), where `operationId` points at file within
      frontend using it.
        - ./api - Endpoints requiring extra logic on backend side, like validation, extra mapping or
          authentication/authorization. In API Schema, these can be identified by "POST" HTTP method type.
        - ./db - Endpoints which were originally fetching data directly from Firestore DB, as these didn't require any
          extra validation or backend operations. In API Schema, these can be identified by "GET" HTTP method type.
    - ./i18n - Configuration for internationalization

### Backend

Set of independent functions providing backend capabilities for the application. Backend is written with running it in
Firebase serverless environment in mind, but these functions can be also connected to any existing framework (eg.
ExpressJS).

All logic is located in:

- `./src/CloudFunctions` - REST API endpoints-like, which are called by frontend part of the application
- `./src/ScheduledFunctions` - Actions which should be executed periodically

### Common

Code which can be shared by frontend and backend.

- ./src
    - ./dataBuilders - Logic for building answers and actions
    - ./helpers - Helper functions
    - ./models - Shared models and data
    - ./schemas - Zod-based data types, which are then used for data validation
    - ./types - Typescript types for improved development experience
